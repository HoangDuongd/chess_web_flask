<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bàn Cờ Vua - Chess Game</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>


<body>
    
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">♔ Bàn Cờ Vua ♛</h1>
        </div>
        
        <div class="game-info">
            <div class="current-player">Lượt: <span id="current-player">Trắng</span></div>
            <div class="game-status" id="game-status">Trò chơi bắt đầu</div>
        </div>
        
        <div class="chess-board" id="chess-board">
            <!-- Bàn cờ sẽ được tạo bằng JavaScript -->
        </div>
        
        <div class="captured-pieces">
            <div class="captured-group">
                <div class="captured-title">Quân Trắng bị bắt</div>
                <div class="captured-list" id="captured-white"></div>
            </div>
            <div class="captured-group">
                <div class="captured-title">Quân Đen bị bắt</div>
                <div class="captured-list" id="captured-black"></div>
            </div>
        </div>
        
        <div class="game-controls">
            <button class="btn" onclick="resetGame()">Chơi lại</button>
            <button class="btn" onclick="undoMove()">Hoàn tác</button>
        </div>
    </div>



<!-- <script>
async function fetchBoard() {
    const response = await fetch("/api/board");
    const data = await response.json();
    const board = data.board;

    const boardContainer = document.getElementById("chess-board");
    boardContainer.innerHTML = "";

    for (let i = 0; i < board.length; i++) {
        for (let j = 0; j < board[i].length; j++) {
            const square = document.createElement("div");
            square.classList.add("chess-square");

            const isWhite = (i + j) % 2 === 0;
            square.classList.add(isWhite ? "white-square" : "black-square");

            if (board[i][j]) {
                square.textContent = board[i][j];  // Unicode piece
            }

            boardContainer.appendChild(square);
        }
    }
}

window.onload = fetchBoard;
</script> -->

<script>
let selected = null;
let legalMoves = [];

async function fetchBoard() {
    const response = await fetch("/api/board");
    const data = await response.json();
    const board = data.board;

    const boardContainer = document.getElementById("chess-board");
    boardContainer.innerHTML = "";

    for (let i = 0; i < board.length; i++) {
        for (let j = 0; j < board[i].length; j++) {
            const square = document.createElement("div");
            square.classList.add("chess-square");

            const isWhite = (i + j) % 2 === 0;
            square.classList.add(isWhite ? "white-square" : "black-square");
            square.dataset.row = i;
            square.dataset.col = j;

            if (board[i][j]) {
                square.textContent = board[i][j];  // Unicode piece
            }

            // Nếu là ô hợp lệ cho nước đi, đánh dấu màu
            if (legalMoves.some(pos => pos[0] === i && pos[1] === j)) {
                square.classList.add("valid-move");
            }

            square.addEventListener("click", () => handleSquareClick(i, j));
            boardContainer.appendChild(square);
        }
    }
}

async function handleSquareClick(i, j) {
    // Nếu click vào ô hợp lệ -> di chuyển
    if (legalMoves.some(pos => pos[0] === i && pos[1] === j)) {
        const res = await fetch(`/api/move`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ from: selected, to: [i, j] })
        });

        const data = await res.json();

        selected = null;
        legalMoves = [];

        if (data.status === "end") {
            showEndGame(data.winner);  // 'white' hoặc 'black'
        }

        await fetchBoard();
        return;
    }

    // Nếu click vào quân cờ -> hiển thị nước đi
    const res = await fetch(`/api/piece?x=${i}&y=${j}`);
    const data = await res.json();

    if (data.exists) {
        selected = [i, j];
        const legal_movesRes = await fetch(`/api/legal_moves?x=${i}&y=${j}`);
        const Data = await legal_movesRes.json();
        legalMoves = Data.moves;
    } else {
        selected = null;
        legalMoves = [];
    }

    await fetchBoard();
}


// nho xoa code sau:
// async function handleSquareClick(i, j) {
//     // Nếu click vào ô hợp lệ -> di chuyển
//     if (legalMoves.some(pos => pos[0] === i && pos[1] === j)) {
//         const res = await fetch(`/api/move`, {
//             method: "POST",
//             headers: { "Content-Type": "application/json" },
//             body: JSON.stringify({ from: selected, to: [i, j] })
//         });

//         const data = await res.json();

//         selected = null;
//         legalMoves = [];

//         if (data.status === "end") {
//             showEndGame(data.winner);
//             await fetchBoard();
//             return;
//         }

//         // Cập nhật bàn cờ sau khi người chơi đánh
//         await fetchBoard();

//         // Nếu tới lượt bot -> gọi bot-move
//         if (data.next_turn === "black") {
//             await callBotMove();
//         }

//         return;
//     }

//     // Nếu click vào quân cờ -> hiển thị nước đi
//     const res = await fetch(`/api/piece?x=${i}&y=${j}`);
//     const data = await res.json();

//     if (data.exists) {
//         selected = [i, j];
//         const legal_movesRes = await fetch(`/api/legal_moves?x=${i}&y=${j}`);
//         const Data = await legal_movesRes.json();
//         legalMoves = Data.moves;
//     } else {
//         selected = null;
//         legalMoves = [];
//     }

//     await fetchBoard();
// }

// async function callBotMove() {
//     const res = await fetch("/api/bot-move", { method: "POST" });
//     const data = await res.json();

//     if (data.status === "end") {
//         showEndGame(data.winner);
//     }

//     await fetchBoard();
// }






















function showEndGame(winner) {
    const overlay = document.getElementById('endgame-overlay');
    const winnerText = document.getElementById('winner-text');
    winnerText.textContent = winner === 'white' ? 'Trắng thắng!' : 'Đen thắng!';
    overlay.classList.remove('hidden');
}




window.onload = fetchBoard;
</script>


<div id="endgame-overlay" class="overlay hidden">
    <div class="endgame-message">
        <h2 id="winner-text">Trắng thắng!</h2>
        <button class="btn" onclick="resetGame()">Chơi lại</button>
    </div>
</div>



</body>


<!-- xem lai code nay, sua doi lai cho phu hop backend. -->