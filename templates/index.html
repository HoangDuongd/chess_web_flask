<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bàn Cờ Vua - Chess Game</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>


<body>
    
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">♔ Bàn Cờ Vua ♛</h1>
        </div>
        
        <div class="game-info">
            <div class="current-player">Lượt: <span id="current-player">Trắng</span></div>
            <div class="game-status" id="game-status">Trò chơi bắt đầu</div>
        </div>
        
        <div class="chess-board" id="chess-board">
            <!-- Bàn cờ sẽ được tạo bằng JavaScript -->
        </div>
        
        <div class="captured-pieces">
            <div class="captured-group">
                <div class="captured-title">Quân Trắng bị bắt</div>
                <div class="captured-list" id="captured-white"></div>
            </div>
            <div class="captured-group">
                <div class="captured-title">Quân Đen bị bắt</div>
                <div class="captured-list" id="captured-black"></div>
            </div>
        </div>
        
        <div class="game-controls">
            <button class="btn" onclick="resetGame()">Chơi lại</button>
            <button class="btn" onclick="undoMove()">Hoàn tác</button>
        </div>
    </div>

<script>
// let selected = null;
let legalMoves = [];
let selected_piece = null

async function fetchBoard() {
    const response = await fetch("/api/board");
    const data = await response.json();
    const board = data.board;

    const boardContainer = document.getElementById("chess-board");
    boardContainer.innerHTML = "";

    for (let i = 0; i < board.length; i++) {
        for (let j = 0; j < board[i].length; j++) {
            const square = document.createElement("div");
            square.classList.add("chess-square");

            const isWhite = (i + j) % 2 === 0;
            square.classList.add(isWhite ? "white-square" : "black-square");
            square.dataset.row = i;
            square.dataset.col = j;

            if (board[i][j]) {
                square.textContent = board[i][j];  // Unicode piece
            }

            // Nếu là ô hợp lệ cho nước đi, đánh dấu màu
            if (legalMoves.some(pos => pos[0] === i && pos[1] === j)) {
                square.classList.add("valid-move");
            }

            square.addEventListener("click", () => handleSquareClick(i, j));
            boardContainer.appendChild(square);
        }
    }
}

async function handleSquareClick(i, j) {
    // Nếu click vào ô hợp lệ -> di chuyển
    if (legalMoves.some(pos => pos[0] === i && pos[1] === j)) {
        if (selected_piece.type == "Pawn" && (i == 7 || i == 0)){
            showPromotionPopup(selected_piece.position, [i,j])
        }
        else {
            await sendMove(selected_piece.position, [i,j])
        }
            return;
    }

    // Nếu click vào quân cờ -> hiển thị nước đi
    const res = await fetch(`/api/piece?x=${i}&y=${j}`);
    selected_piece = await res.json();

    if (selected_piece.exists) {
        selected_piece.position = [i, j];
        const legal_movesRes = await fetch(`/api/legal_moves?x=${i}&y=${j}`);
        const Data = await legal_movesRes.json();
        legalMoves = Data.moves;
    } else {
        selected_piece = null;
        legalMoves = [];
    }

    await fetchBoard();
}


function showEndGame(winner) {
    const overlay = document.getElementById('endgame-overlay');
    const winnerText = document.getElementById('winner-text');
    winnerText.textContent = winner === 'white' ? 'Trắng thắng!' : 'Đen thắng!';
    overlay.classList.remove('hidden');
}


function showPromotionPopup(from, to) {
    const popup = document.createElement("div");
    popup.classList.add("promotion-popup");
    popup.innerHTML = `
        <div>Chọn quân để phong cấp:</div>
        <button onclick="promote('Q')">♛ Hậu</button>
        <button onclick="promote('R')">♜ Xe</button>
        <button onclick="promote('B')">♝ Tượng</button>
        <button onclick="promote('N')">♞ Mã</button>
    `;
    document.body.appendChild(popup);

    window.promote = async function(piece) {
        document.body.removeChild(popup);
        await sendMove(from, to, piece);
    }
}

async function sendMove(from_position, to_position, promotion_type = null) {
    const res = await fetch(`/api/move`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from:from_position, to:to_position, promotion:promotion_type })
    });
    const data = await res.json();

    selected_piece = null;
    legalMoves = [];

    if (data.status === "end") {
        showEndGame(data.winner);
    }

    await fetchBoard();
}


window.onload = fetchBoard;
</script>


<div id="endgame-overlay" class="overlay hidden">
    <div class="endgame-message">
        <h2 id="winner-text">Trắng thắng!</h2>
        <button class="btn" onclick="resetGame()">Chơi lại</button>
    </div>
</div>



</body>


<!-- xem lai code nay, sua doi lai cho phu hop backend. -->